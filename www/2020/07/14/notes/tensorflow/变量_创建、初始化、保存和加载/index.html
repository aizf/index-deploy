<h1 id="变量-创建、初始化、保存和加载"><a href="#变量-创建、初始化、保存和加载" class="headerlink" title="变量:创建、初始化、保存和加载"></a>变量:创建、初始化、保存和加载</h1><p>当训练模型时，用变量来存储和更新参数。变量包含张量 (Tensor)存放于内存的缓存区。<strong>建模时它们需要被明确地初始化</strong>，模型训练后它们必须被存储到磁盘。这些变量的值可在之后模型训练和分析时被加载。<br>本文档描述以下两个TensorFlow类。</p>
<ul>
<li>tf.Variable 类</li>
<li>tf.train.Saver 类</li>
</ul>
<h2 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h2><p>当创建一个变量时，你将一个张量作为初始值传入构造函数Variable()。初始值是常量或是随机值。<br>变量的shape通常是固定的，但TensorFlow提供了高级的机制来重新调整其行列数。</p>
<div class="hljs"><pre><code class="hljs reasonml"># Create two variables.
weights = tf.<span class="hljs-constructor">Variable(<span class="hljs-params">tf</span>.<span class="hljs-params">random_normal</span>([784, 200], <span class="hljs-params">stddev</span>=0.35)</span>,
                      name=<span class="hljs-string">"weights"</span>)
biases = tf.<span class="hljs-constructor">Variable(<span class="hljs-params">tf</span>.<span class="hljs-params">zeros</span>([200])</span>, name=<span class="hljs-string">"biases"</span>)</code></pre></div>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><p>变量的初始化必须在模型的其它操作运行之前先明确地完成。最简单的方法就是添加一个给所有变量初始化的操作，并在使用模型之前首先运行那个操作。</p>
<p>使用tf.initialize_all_variables()添加一个操作对变量做初始化。记得在完全构建好模型并加载之后再运行那个操作。</p>
<div class="hljs"><pre><code class="hljs routeros"><span class="hljs-comment"># Create two variables.</span>
weights = tf.Variable(tf.random_normal([784, 200], <span class="hljs-attribute">stddev</span>=0.35),
                      <span class="hljs-attribute">name</span>=<span class="hljs-string">"weights"</span>)
biases = tf.Variable(tf.zeros([200]), <span class="hljs-attribute">name</span>=<span class="hljs-string">"biases"</span>)
<span class="hljs-built_in">..</span>.
<span class="hljs-comment"># Add an op to initialize the variables.</span>
init_op = tf.initialize_all_variables()

<span class="hljs-comment"># Later, when launching the model</span>
with tf.Session() as sess:
  # <span class="hljs-builtin-name">Run</span> the init operation.
  sess.<span class="hljs-builtin-name">run</span>(init_op)
  <span class="hljs-built_in">..</span>.
  # Use the model
  <span class="hljs-built_in">..</span>.</code></pre></div>
<h3 id="由另一个变量初始化"><a href="#由另一个变量初始化" class="headerlink" title="由另一个变量初始化"></a>由另一个变量初始化</h3><p>tf.initialize_all_variables()是<strong>并行地初始化所有变量</strong></p>
<ul>
<li>使用其它变量的initialized_value()属性。</li>
<li>你可以直接把已初始化的值作为新变量的初始值</li>
<li>或者把它当做tensor计算得到一个值赋予新变量。</li>
</ul>
<div class="hljs"><pre><code class="hljs pgsql"># <span class="hljs-keyword">Create</span> a variable <span class="hljs-keyword">with</span> a random <span class="hljs-keyword">value</span>.
weights = tf.Variable(tf.random_normal([<span class="hljs-number">784</span>, <span class="hljs-number">200</span>], stddev=<span class="hljs-number">0.35</span>),
                      <span class="hljs-type">name</span>="weights")
# <span class="hljs-keyword">Create</span> another variable <span class="hljs-keyword">with</span> the same <span class="hljs-keyword">value</span> <span class="hljs-keyword">as</span> <span class="hljs-string">'weights'</span>.
w2 = tf.Variable(weights.initialized_value(), <span class="hljs-type">name</span>="w2")
# <span class="hljs-keyword">Create</span> another variable <span class="hljs-keyword">with</span> twice the <span class="hljs-keyword">value</span> <span class="hljs-keyword">of</span> <span class="hljs-string">'weights'</span>
w_twice = tf.Variable(weights.initialized_value() * <span class="hljs-number">0.2</span>, <span class="hljs-type">name</span>="w_twice")</code></pre></div>
<h3 id="自定义初始化"><a href="#自定义初始化" class="headerlink" title="自定义初始化"></a>自定义初始化</h3><p>tf.initialize_all_variables()函数便捷地添加一个op来初始化模型的所有变量。<strong>你也可以给它传入一组变量进行初始化。</strong></p>
<p>详情请见Variables Documentation，包括检查变量是否被初始化。</p>
<h2 id="保存和加载"><a href="#保存和加载" class="headerlink" title="保存和加载"></a>保存和加载</h2><p>最简单的保存和恢复模型的方法是使用tf.train.Saver对象。构造器给graph的所有变量，或是定义在列表里的变量，添加save和restoreops。saver对象提供了方法来运行这些ops，定义检查点文件的读写路径。</p>
<h3 id="检查点文件"><a href="#检查点文件" class="headerlink" title="检查点文件"></a>检查点文件</h3><p>变量存储在二进制文件里，主要包含从变量名到tensor值的映射关系。</p>
<p>当你创建一个Saver对象时，你可以选择性地为检查点文件中的变量挑选变量名。默认情况下，将每个变量Variable.name属性的值。</p>
<h3 id="保存变量"><a href="#保存变量" class="headerlink" title="保存变量"></a>保存变量</h3><p>用tf.train.Saver()创建一个Saver来管理模型中的所有变量。</p>
<div class="hljs"><pre><code class="hljs routeros"><span class="hljs-comment"># Create some variables.</span>
v1 = tf.Variable(<span class="hljs-built_in">..</span>., <span class="hljs-attribute">name</span>=<span class="hljs-string">"v1"</span>)
v2 = tf.Variable(<span class="hljs-built_in">..</span>., <span class="hljs-attribute">name</span>=<span class="hljs-string">"v2"</span>)
<span class="hljs-built_in">..</span>.
<span class="hljs-comment"># Add an op to initialize the variables.</span>
init_op = tf.initialize_all_variables()

<span class="hljs-comment"># Add ops to save and restore all the variables.</span>
saver = tf.train.Saver()

<span class="hljs-comment"># Later, launch the model, initialize the variables, do some work, save the</span>
<span class="hljs-comment"># variables to disk.</span>
with tf.Session() as sess:
  sess.<span class="hljs-builtin-name">run</span>(init_op)
  # <span class="hljs-keyword">Do</span> some work with the model.
  <span class="hljs-built_in">..</span>
  # Save the variables <span class="hljs-keyword">to</span> disk.
  save_path = saver.save(sess, <span class="hljs-string">"/tmp/model.ckpt"</span>)
  <span class="hljs-builtin-name">print</span> <span class="hljs-string">"Model saved in file: "</span>, save_path</code></pre></div>
<h3 id="恢复变量"><a href="#恢复变量" class="headerlink" title="恢复变量"></a>恢复变量</h3><p>用同一个Saver对象来恢复变量。注意，当你从文件中恢复变量时，不需要事先对它们做初始化。</p>
<div class="hljs"><pre><code class="hljs routeros"><span class="hljs-comment"># Create some variables.</span>
v1 = tf.Variable(<span class="hljs-built_in">..</span>., <span class="hljs-attribute">name</span>=<span class="hljs-string">"v1"</span>)
v2 = tf.Variable(<span class="hljs-built_in">..</span>., <span class="hljs-attribute">name</span>=<span class="hljs-string">"v2"</span>)
<span class="hljs-built_in">..</span>.
<span class="hljs-comment"># Add ops to save and restore all the variables.</span>
saver = tf.train.Saver()

<span class="hljs-comment"># Later, launch the model, use the saver to restore variables from disk, and</span>
<span class="hljs-comment"># do some work with the model.</span>
with tf.Session() as sess:
  # Restore variables <span class="hljs-keyword">from</span> disk.
  saver.restore(sess, <span class="hljs-string">"/tmp/model.ckpt"</span>)
  <span class="hljs-builtin-name">print</span> <span class="hljs-string">"Model restored."</span>
  # <span class="hljs-keyword">Do</span> some work with the model
  <span class="hljs-built_in">..</span>.</code></pre></div>
<h3 id="选择存储和恢复哪些变量"><a href="#选择存储和恢复哪些变量" class="headerlink" title="选择存储和恢复哪些变量"></a>选择存储和恢复哪些变量</h3><p>如果你不给tf.train.Saver()传入任何参数，那么saver将处理graph中的所有变量。其中每一个变量都以变量创建时传入的名称被保存。</p>
<p>你可以通过给tf.train.Saver()构造函数传入Python字典，很容易地定义需要保持的变量及对应名称：键对应使用的名称，值对应被管理的变量。<br>注意：</p>
<ul>
<li>如果需要保存和恢复模型变量的不同子集，可以创建任意多个saver对象。同一个变量可被列入多个saver对象中，只有当saver的restore()函数被运行时，它的值才会发生改变。</li>
<li>如果你仅在session开始时恢复模型变量的一个子集，你需要对剩下的变量执行初始化op。详情请见tf.initialize_variables()。</li>
</ul>
